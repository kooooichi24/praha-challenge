# 本番稼働中のデータベースをマイグレーションしよう

## 課題内容

[airtable](https://airtable.com/appWjizyFJue33ycs/tblTnXBXFOYJ0J7lZ/viwyi8muFtWUlhNKG/recic3eCyBrLZpyGU?blocks=hide)

---

## 1. 
### マイグレーションとは
- マイグレーションとは、状態を移行させること
- DBにおけるマイグレーションとは、DBのテーブル定義を変更させること
- マイグレーションツールを用いることで、開発者間で変更を共有および検知できる
- もし、マイグレーションツールを導入していなかったら
  - 他の誰かがテーブル定義を変更したことに気づかずに、古いテーブル定義のまま、開発をしていました、、、、ということが発生してしまう

### Expand and contract pattern とは
- マイグレーションの手法の一種
- 既存のデータ構造と並列に、新しいデータ構造を導入することで、ダウンタイムを発生させることなくデータ移行できるような手法

### Expand and contract pattern の方法
7つのステップで実現できる
1. 新しいスキーマを作成＆デプロイ

    要件を満たす新たなスキーマを作成する。この際に、既存のスキーマは変更しない。
    例えば、`name`カラムを`first_name`、`last_name`カラムに変更したい場合は、`name`カラムのテーブルに、`first_name`、`last_name`カラムを新規追加する。
    
    カラムレベルの変更の場合は、現在のカラムをそのままにして、新しいカラムをテーブルに追加する。より複雑な変更の場合は、新しいテーブルを作成する。

2. インターフェースの拡張

    DBの書き込み操作の時のみ、既存のスキーマと新しいスキーマの両方に書き込み処理を実施する。

3. 既存のデータを新しいスキーマへ移行

    新しいスキーマは、2.のステップ以前のデータを保持していないので、既存のデータを新しいスキーマに移行する。

4. 新しいインターフェースのテスト

    新しいスキーマへの書き込みのインターフェースが正しいことや、正しく読み込みが実施できることをテストする。

5. 新しいスキーマからの読み込みを有効にする

    インターフェースを修正し、既存のスキーマからの読み込みを削除し、新しいスキーマからの読み込みを有効にする。
    
    このステップでは、既存のスキーマへの書き込み処理は削除しない。なぜなら、何かしらの不具合が発生したときに、既存のスキーマへのロールバックを実施できるから。

6. 既存のスキーマへの書き込みを削除する

    ステップ5で、正しく動作することが確認できたので、既存のスキーマへの書き込みを削除する

7. 既存のスキーマを削除

    既存のスキーマを削除する

### NOT NULL制約 によるマイグレーションの失敗を防ぐためには
- 例
    
    |id|name  |
    |--|------|
    |1 |Tanaka|
    |2 |Sato  |
    |3 |Suzuki|

    上記のテーブルに、新たに`age`カラムを追加するケース

- 発生原因
  - NOT NULL制約のカラムを追加したい既存テーブルに、既存レコードが存在し、その値がNULLになってしまうから
- 解決策
  - デフォルト値を用いる
    - デフォルト値とNOT NULL制約を指定してマイグレーション実施
    - その後、デフォルト値の設定を削除する

## 2.



### メモ
## 参考文献
- [Using the expand and contract pattern for schema changes](https://www.prisma.io/dataguide/types/relational/expand-and-contract-pattern)
- [ParallelChange](https://martinfowler.com/bliki/ParallelChange.html)